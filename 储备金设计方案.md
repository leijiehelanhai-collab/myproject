# å¤šè½®æ¸¸æˆå‚¨å¤‡é‡‘è®¾è®¡æ–¹æ¡ˆ

## ğŸš¨ ç°æœ‰é—®é¢˜åˆ†æ

å½“å‰å¤šè½®åˆçº¦ä¸­ï¼Œå‚¨å¤‡é‡‘è®¾è®¡å­˜åœ¨ä¸¥é‡ç¼ºé™·ï¼š

1. **å…¨å±€å‚¨å¤‡é‡‘æ··ä¹±**ï¼šæ‰€æœ‰è½®æ¬¡çš„15%å‚¨å¤‡é‡‘éƒ½æµå…¥åŒä¸€ä¸ª `globalReserve`
2. **ä¸å…¬å¹³åˆ†é…**ï¼šç¬¬ä¸€ä¸ªç»“ç®—çš„è½®æ¬¡æ‹¿èµ°æ‰€æœ‰å‚¨å¤‡é‡‘ï¼Œåç»­è½®æ¬¡æ²¡æœ‰å‚¨å¤‡é‡‘
3. **ç»æµæ¨¡å‹å¤±è¡¡**ï¼šå¤šè½®æ¬¡ä¹‹é—´ç¼ºä¹å…¬å¹³çš„æ¿€åŠ±æœºåˆ¶

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1ï¼šç‹¬ç«‹å‚¨å¤‡é‡‘æ±  â­â­â­â­â­ ï¼ˆæ¨èï¼‰

**è®¾è®¡ç†å¿µ**ï¼šæ¯ä¸ªè½®æ¬¡ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„å‚¨å¤‡é‡‘

```solidity
struct Round {
    // ... å…¶ä»–å­—æ®µ
    uint256 reservePool;    // æœ¬è½®æ¬¡çš„å‚¨å¤‡é‡‘æ± 
    bool hasReserveBonus;   // æ˜¯å¦æœ‰å‚¨å¤‡é‡‘åŠ æˆ
}

// å‚ä¸æ¸¸æˆæ—¶
function joinRound(uint256 _roundId) external payable {
    // åˆ†é…èµ„é‡‘
    uint256 potAmount = (msg.value * 800) / 1000;      // 80% æœ¬è½®å¥–æ± 
    uint256 devAmount = (msg.value * 50) / 1000;       // 5% å¼€å‘è´¹
    uint256 reserveAmount = (msg.value * 150) / 1000;  // 15% æœ¬è½®å‚¨å¤‡

    round.currentPot += potAmount;
    round.reservePool += reserveAmount;  // å‚¨å¤‡é‡‘å½’å±æœ¬è½®æ¬¡
}

// ç»“ç®—æ—¶
function _settleRound(uint256 _roundId) internal {
    uint256 totalPrize = round.currentPot + round.reservePool;
    // èµ¢å®¶è·å¾—ï¼šæœ¬è½®å¥–æ±  + æœ¬è½®å‚¨å¤‡é‡‘
}
```

**ä¼˜ç‚¹**ï¼š
âœ… æ¯è½®ç‹¬ç«‹ï¼Œå…¬å¹³é€æ˜
âœ… å‚¨å¤‡é‡‘ç›´æ¥æ¿€åŠ±æœ¬è½®ç©å®¶
âœ… é€»è¾‘ç®€å•ï¼Œä¸ä¼šå‡ºé”™

**ç¼ºç‚¹**ï¼š
âŒ å‚¨å¤‡é‡‘æ•ˆåº”è¾ƒå¼±ï¼ˆä»…15%é¢å¤–å¥–åŠ±ï¼‰

---

### æ–¹æ¡ˆ2ï¼šå¾ªç¯å‚¨å¤‡é‡‘ â­â­â­â­

**è®¾è®¡ç†å¿µ**ï¼šå‚¨å¤‡é‡‘æµå‘ä¸‹ä¸€ä¸ªå¼€å¯çš„è½®æ¬¡

```solidity
uint256 public pendingReserve;  // å¾…åˆ†é…å‚¨å¤‡é‡‘
uint256 public lastReserveRound; // æœ€åä¸€ä¸ªè·å¾—å‚¨å¤‡é‡‘çš„è½®æ¬¡ID

function startNewRound(...) external onlyOwner {
    Round storage newRound = rounds[newRoundId];
    
    // æ–°è½®æ¬¡è·å¾—ä¹‹å‰ç´¯ç§¯çš„å‚¨å¤‡é‡‘
    newRound.initialReserve = pendingReserve;
    pendingReserve = 0;
    lastReserveRound = newRoundId;
}

function _settleRound(uint256 _roundId) internal {
    // èµ¢å®¶è·å¾—ï¼šæœ¬è½®å¥–æ±  + åˆå§‹å‚¨å¤‡é‡‘
    uint256 totalPrize = round.currentPot + round.initialReserve;
    
    // æœ¬è½®äº§ç”Ÿçš„å‚¨å¤‡é‡‘ç•™ç»™ä¸‹ä¸€è½®
    pendingReserve += (æœ¬è½®æ€»æ”¶å…¥ * 150) / 1000;
}
```

**ä¼˜ç‚¹**ï¼š
âœ… å‚¨å¤‡é‡‘æœ‰æ˜ç¡®æµå‘
âœ… æ¿€åŠ±å¼€å¯æ–°è½®æ¬¡
âœ… å½¢æˆæ­£å‘å¾ªç¯

**ç¼ºç‚¹**ï¼š
âŒ ç¬¬ä¸€è½®æ²¡æœ‰å‚¨å¤‡é‡‘
âŒ é€»è¾‘ç¨å¤æ‚

---

### æ–¹æ¡ˆ3ï¼šæ™ºèƒ½åˆ†é…æ±  â­â­â­

**è®¾è®¡ç†å¿µ**ï¼šå‚¨å¤‡é‡‘æŒ‰æ´»è·ƒè½®æ¬¡æ•°é‡æ™ºèƒ½åˆ†é…

```solidity
function _distributeReserve(uint256 reserveAmount) internal {
    uint256[] memory activeRoundIds = getActiveRounds();
    uint256 perRoundReserve = reserveAmount / activeRoundIds.length;
    
    for (uint256 i = 0; i < activeRoundIds.length; i++) {
        rounds[activeRoundIds[i]].reservePool += perRoundReserve;
    }
}
```

**ä¼˜ç‚¹**ï¼š
âœ… æ‰€æœ‰æ´»è·ƒè½®æ¬¡éƒ½èƒ½å—ç›Š
âœ… åŠ¨æ€å¹³è¡¡æ¿€åŠ±

**ç¼ºç‚¹**ï¼š
âŒ å®ç°å¤æ‚
âŒ gasæ¶ˆè€—è¾ƒé«˜

---

### æ–¹æ¡ˆ4ï¼šå»¶è¿Ÿå¥–æ±  â­â­â­â­

**è®¾è®¡ç†å¿µ**ï¼šå‚¨å¤‡é‡‘ç´¯ç§¯åˆ°ä¸€å®šæ•°é‡åï¼Œè§¦å‘ç‰¹æ®Šå¥–åŠ±è½®æ¬¡

```solidity
uint256 public constant SPECIAL_ROUND_THRESHOLD = 1 ether; // 1 BNBè§¦å‘ç‰¹æ®Šè½®æ¬¡
uint256 public globalReserve;

function checkSpecialRound() internal {
    if (globalReserve >= SPECIAL_ROUND_THRESHOLD) {
        // è‡ªåŠ¨å¼€å¯ç‰¹æ®Šè½®æ¬¡ï¼Œå¥–æ±  = globalReserve
        startSpecialRound(globalReserve);
        globalReserve = 0;
    }
}
```

**ä¼˜ç‚¹**ï¼š
âœ… åˆ›é€ æœŸå¾…æ„Ÿå’ŒæƒŠå–œ
âœ… å¤§å¥–æ± å¸å¼•æ›´å¤šç©å®¶
âœ… å‚¨å¤‡é‡‘æœ‰æ˜ç¡®ç”¨é€”

**ç¼ºç‚¹**ï¼š
âŒ éœ€è¦è‡ªåŠ¨åŒ–è§¦å‘æœºåˆ¶
âŒ å¢åŠ åˆçº¦å¤æ‚æ€§

---

## ğŸ¯ æ¨èå®ç°ï¼šæ–¹æ¡ˆ1ï¼ˆç‹¬ç«‹å‚¨å¤‡é‡‘æ± ï¼‰

**ç«‹å³ä¿®å¤å»ºè®®**ï¼š

1. **ä¿®æ”¹æ•°æ®ç»“æ„**ï¼š
```solidity
struct Round {
    // ... ç°æœ‰å­—æ®µ
    uint256 reservePool;    // æ–°å¢ï¼šæœ¬è½®å‚¨å¤‡é‡‘
}
```

2. **ä¿®æ”¹joinRoundå‡½æ•°**ï¼š
```solidity
// åŸæ¥ï¼šglobalReserve += reserveAmount;
// æ”¹ä¸ºï¼šround.reservePool += reserveAmount;
```

3. **ä¿®æ”¹ç»“ç®—å‡½æ•°**ï¼š
```solidity
// åŸæ¥ï¼šuint256 totalPrize = round.currentPot + globalReserve;
// æ”¹ä¸ºï¼šuint256 totalPrize = round.currentPot + round.reservePool;
```

4. **ç§»é™¤å…¨å±€å‚¨å¤‡é‡‘é‡ç½®**ï¼š
```solidity
// åˆ é™¤ï¼šglobalReserve = 0;
```

---

## ğŸš€ è¿›é˜¶æ–¹æ¡ˆï¼šæ··åˆæ¨¡å¼

ç»“åˆæ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ4ï¼š

- **80%å‚¨å¤‡é‡‘**ï¼šå½’å±æœ¬è½®æ¬¡ï¼ˆç«‹å³æ¿€åŠ±ï¼‰
- **20%å‚¨å¤‡é‡‘**ï¼šæµå…¥å…¨å±€æ± ï¼ˆç´¯ç§¯å¤§å¥–ï¼‰

```solidity
uint256 localReserve = reserveAmount * 800 / 1000;  // 80%ç»™æœ¬è½®
uint256 globalReserve = reserveAmount * 200 / 1000; // 20%ç»™å…¨å±€

round.reservePool += localReserve;
this.globalReserve += globalReserve;
```

---

## ğŸ® å‰ç«¯æ˜¾ç¤ºå»ºè®®

ä¸åŒæ–¹æ¡ˆçš„å‰ç«¯æ˜¾ç¤ºï¼š

```javascript
// æ–¹æ¡ˆ1ï¼šç‹¬ç«‹å‚¨å¤‡é‡‘
å¥–æ± : 0.8 BNB
å‚¨å¤‡é‡‘: 0.12 BNB  // æœ¬è½®15%å‚¨å¤‡
æ€»å¥–åŠ±: 0.92 BNB

// æ–¹æ¡ˆ4ï¼šå»¶è¿Ÿå¥–æ± 
å¥–æ± : 0.8 BNB
å…¨å±€å‚¨å¤‡: 0.85 BNB  // è·ç¦»ç‰¹æ®Šè½®æ¬¡è¿˜éœ€0.15 BNB
```

---

## âš¡ ç´§æ€¥ä¿®å¤

å¦‚æœè¦ç«‹å³ä¿®å¤å½“å‰é—®é¢˜ï¼Œæœ€ç®€å•çš„æ–¹æ³•ï¼š

```solidity
// ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šå–æ¶ˆå‚¨å¤‡é‡‘æœºåˆ¶
uint256 potAmount = (msg.value * 950) / 1000;  // 95% å¥–æ± 
uint256 devAmount = (msg.value * 50) / 1000;   // 5% å¼€å‘è´¹
// åˆ é™¤å‚¨å¤‡é‡‘åˆ†é…

round.currentPot += potAmount;
// åˆ é™¤ globalReserve ç›¸å…³ä»£ç 
```

è¿™æ ·è™½ç„¶å–æ¶ˆäº†å‚¨å¤‡é‡‘æ¿€åŠ±ï¼Œä½†é¿å…äº†ä¸å…¬å¹³åˆ†é…çš„é—®é¢˜ã€‚

---

**ä½ å€¾å‘äºå“ªç§æ–¹æ¡ˆï¼Ÿæˆ‘å¯ä»¥ç«‹å³å¸®ä½ å®ç°ï¼** ğŸ¯
