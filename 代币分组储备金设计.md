# ä»£å¸åˆ†ç»„å‚¨å¤‡é‡‘è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ è®¾è®¡ç†å¿µ

æ¯ç§ERC20ä»£å¸å½¢æˆç‹¬ç«‹çš„æ¸¸æˆå¾ªç¯ï¼š
- æ¯ç§ä»£å¸åŒæ—¶åªèƒ½æœ‰1åœºæ´»è·ƒæ¸¸æˆ
- æ¯ç§ä»£å¸æœ‰ç‹¬ç«‹çš„å‚¨å¤‡é‡‘æ± 
- å‚¨å¤‡é‡‘åªæµå‘åŒç§ä»£å¸çš„ä¸‹ä¸€åœºæ¸¸æˆ

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

```solidity
contract UniversalCardGame {
    // ============ ä»£å¸åˆ†ç»„ç®¡ç† ============
    
    // æ¯ç§ä»£å¸çš„å½“å‰æ´»è·ƒè½®æ¬¡IDï¼ˆ0è¡¨ç¤ºæ— æ´»è·ƒè½®æ¬¡ï¼‰
    mapping(address => uint256) public tokenActiveRound;
    
    // æ¯ç§ä»£å¸çš„å‚¨å¤‡é‡‘æ± 
    mapping(address => uint256) public tokenReservePools;
    
    // æ¯ç§ä»£å¸çš„å†å²è½®æ¬¡æ•°
    mapping(address => uint256) public tokenRoundCounts;
    
    // è½®æ¬¡ä¿¡æ¯
    struct Round {
        uint256 roundId;
        address tokenAddress;
        uint256 burnAmount;
        uint256 ticketPrice;
        uint256 startTime;
        uint256 endTime;
        address[] participants;
        mapping(address => uint256) playerNumbers;
        uint256[] availableNumbers;
        uint256 participantCount;
        uint256 currentPot;
        uint256 maxNumber;
        address maxNumberHolder;
        bool isSettled;
        bool isActive;
        uint256 inheritedReserve;  // ä»å‚¨å¤‡æ± ç»§æ‰¿çš„å¥–é‡‘
    }
    
    // ============ ä»£å¸ç®¡ç†å‡½æ•° ============
    
    /**
     * @notice æ£€æŸ¥ä»£å¸æ˜¯å¦å¯ä»¥å¼€å¯æ–°è½®æ¬¡
     */
    function canStartNewRound(address tokenAddress) public view returns (bool) {
        return tokenActiveRound[tokenAddress] == 0;
    }
    
    /**
     * @notice è·å–ä»£å¸çš„å‚¨å¤‡é‡‘ä¿¡æ¯
     */
    function getTokenReserveInfo(address tokenAddress) external view returns (
        uint256 reservePool,
        uint256 activeRoundId,
        uint256 totalRounds
    ) {
        return (
            tokenReservePools[tokenAddress],
            tokenActiveRound[tokenAddress],
            tokenRoundCounts[tokenAddress]
        );
    }
}
```

## ğŸš€ æ ¸å¿ƒå‡½æ•°å®ç°

### 1. å¼€å¯æ–°è½®æ¬¡ï¼ˆä»£å¸æ£€æŸ¥ï¼‰

```solidity
function startNewRound(
    address _tokenAddress,
    uint256 _burnAmount,
    uint256 _ticketPrice,
    uint256 _duration
) external onlyOwner {
    // æ£€æŸ¥è¯¥ä»£å¸æ˜¯å¦å·²æœ‰æ´»è·ƒè½®æ¬¡
    require(tokenActiveRound[_tokenAddress] == 0, "Token already has active round");
    
    totalRoundsCreated++;
    uint256 newRoundId = totalRoundsCreated;
    
    Round storage newRound = rounds[newRoundId];
    newRound.roundId = newRoundId;
    newRound.tokenAddress = _tokenAddress;
    newRound.burnAmount = _burnAmount;
    newRound.ticketPrice = _ticketPrice;
    newRound.startTime = block.timestamp;
    newRound.endTime = block.timestamp + _duration;
    newRound.isActive = true;
    
    // ç»§æ‰¿è¯¥ä»£å¸çš„å‚¨å¤‡é‡‘
    newRound.inheritedReserve = tokenReservePools[_tokenAddress];
    tokenReservePools[_tokenAddress] = 0;  // æ¸…ç©ºå‚¨å¤‡æ± 
    
    // è®¾ç½®ä¸ºè¯¥ä»£å¸çš„æ´»è·ƒè½®æ¬¡
    tokenActiveRound[_tokenAddress] = newRoundId;
    tokenRoundCounts[_tokenAddress]++;
    
    // åˆå§‹åŒ–å·ç æ± 
    for (uint256 i = 1; i <= MAX_PLAYERS; i++) {
        newRound.availableNumbers.push(i);
    }
    
    activeRounds.push(newRoundId);
    
    emit RoundStarted(newRoundId, _tokenAddress, _burnAmount, _ticketPrice, newRound.endTime);
}
```

### 2. å‚ä¸æ¸¸æˆï¼ˆå‚¨å¤‡é‡‘åˆ†é…ï¼‰

```solidity
function joinRound(uint256 _roundId) external payable {
    Round storage round = rounds[_roundId];
    
    // ... åŸæœ‰æ£€æŸ¥é€»è¾‘ ...
    
    // ç‡ƒçƒ§ä»£å¸
    IERC20 token = IERC20(round.tokenAddress);
    require(
        token.transferFrom(msg.sender, DEAD_ADDRESS, round.burnAmount),
        "Token transfer failed"
    );
    
    // åˆ†é…èµ„é‡‘
    uint256 potAmount = (msg.value * POT_SHARE) / 1000;        // 80% æœ¬è½®å¥–æ± 
    uint256 devAmount = (msg.value * DEV_FEE) / 1000;          // 5% å¼€å‘è´¹
    uint256 reserveAmount = (msg.value * NEXT_ROUND_RESERVE) / 1000; // 15% ä»£å¸å‚¨å¤‡æ± 
    
    round.currentPot += potAmount;
    
    // å‚¨å¤‡é‡‘æµå…¥è¯¥ä»£å¸çš„å‚¨å¤‡æ± ï¼ˆç”¨äºä¸‹ä¸€åœºï¼‰
    tokenReservePools[round.tokenAddress] += reserveAmount;
    
    // å‘é€å¼€å‘è´¹
    if (devAmount > 0) {
        payable(devWallet).transfer(devAmount);
    }
    
    // ... æŠ½å·ç é€»è¾‘ ...
}
```

### 3. ç»“ç®—è½®æ¬¡ï¼ˆé‡Šæ”¾ä»£å¸ä½ç½®ï¼‰

```solidity
function _settleRound(uint256 _roundId) internal {
    Round storage round = rounds[_roundId];
    round.isSettled = true;
    round.isActive = false;
    
    // é‡Šæ”¾è¯¥ä»£å¸çš„æ´»è·ƒä½ç½®
    tokenActiveRound[round.tokenAddress] = 0;
    
    // ä»æ´»è·ƒåˆ—è¡¨ç§»é™¤
    _removeFromActiveRounds(_roundId);
    
    if (round.participants.length > 0 && round.maxNumberHolder != address(0)) {
        // è®¡ç®—æ€»å¥–é‡‘ï¼šæœ¬è½®å¥–æ±  + ç»§æ‰¿çš„å‚¨å¤‡é‡‘
        uint256 totalPrize = round.currentPot + round.inheritedReserve;
        
        payable(round.maxNumberHolder).transfer(totalPrize);
        
        emit RoundSettled(_roundId, round.maxNumberHolder, totalPrize);
    }
    
    // æ¸…ç†ç©å®¶è®°å½•
    // ...
}
```

## ğŸ® å‰ç«¯æ˜¾ç¤ºè®¾è®¡

```javascript
// ä»£å¸å‚¨å¤‡é‡‘ä¿¡æ¯ç»„ä»¶
function TokenReserveInfo({ tokenAddress, contract }) {
    const [reserveInfo, setReserveInfo] = useState({
        reservePool: '0',
        activeRoundId: 0,
        totalRounds: 0
    });
    
    useEffect(() => {
        if (contract && tokenAddress) {
            contract.methods.getTokenReserveInfo(tokenAddress).call()
                .then(info => setReserveInfo({
                    reservePool: Web3.utils.fromWei(info.reservePool, 'ether'),
                    activeRoundId: Number(info.activeRoundId),
                    totalRounds: Number(info.totalRounds)
                }));
        }
    }, [contract, tokenAddress]);
    
    return (
        <div className="bg-white/10 rounded-lg p-4">
            <h4 className="text-lg font-bold">ä»£å¸å‚¨å¤‡ä¿¡æ¯</h4>
            <div className="grid grid-cols-3 gap-4 mt-2">
                <div>
                    <div className="text-2xl font-bold text-green-400">
                        {reserveInfo.reservePool} BNB
                    </div>
                    <div className="text-sm text-gray-400">å¾…åˆ†é…å‚¨å¤‡é‡‘</div>
                </div>
                <div>
                    <div className="text-2xl font-bold text-blue-400">
                        {reserveInfo.totalRounds}
                    </div>
                    <div className="text-sm text-gray-400">å†å²è½®æ¬¡</div>
                </div>
                <div>
                    <div className="text-2xl font-bold text-orange-400">
                        {reserveInfo.activeRoundId > 0 ? 'è¿›è¡Œä¸­' : 'å¯å¼€å¯'}
                    </div>
                    <div className="text-sm text-gray-400">çŠ¶æ€</div>
                </div>
            </div>
        </div>
    );
}
```

## ğŸ“Š ç®¡ç†å‘˜ç•Œé¢ä¼˜åŒ–

```javascript
// ä»£å¸é€‰æ‹©å’ŒçŠ¶æ€æ£€æŸ¥
function AdminTokenSelector({ onTokenSelect }) {
    const [tokenAddress, setTokenAddress] = useState('');
    const [tokenStatus, setTokenStatus] = useState(null);
    
    const checkTokenStatus = async () => {
        if (!contract || !Web3.utils.isAddress(tokenAddress)) return;
        
        const canStart = await contract.methods.canStartNewRound(tokenAddress).call();
        const reserveInfo = await contract.methods.getTokenReserveInfo(tokenAddress).call();
        
        setTokenStatus({
            canStart,
            reservePool: Web3.utils.fromWei(reserveInfo.reservePool, 'ether'),
            activeRoundId: Number(reserveInfo.activeRoundId),
            totalRounds: Number(reserveInfo.totalRounds)
        });
    };
    
    return (
        <div className="space-y-4">
            <div>
                <label className="block text-sm font-medium mb-2">ä»£å¸åœ°å€</label>
                <div className="flex gap-2">
                    <input
                        type="text"
                        value={tokenAddress}
                        onChange={(e) => setTokenAddress(e.target.value)}
                        className="flex-1 bg-white/5 border border-white/20 rounded-lg px-4 py-2"
                        placeholder="0x... (ERC20ä»£å¸åœ°å€)"
                    />
                    <button
                        onClick={checkTokenStatus}
                        className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg"
                    >
                        æ£€æŸ¥çŠ¶æ€
                    </button>
                </div>
            </div>
            
            {tokenStatus && (
                <div className={`p-4 rounded-lg ${tokenStatus.canStart ? 'bg-green-500/20 border border-green-500/50' : 'bg-red-500/20 border border-red-500/50'}`}>
                    {tokenStatus.canStart ? (
                        <div>
                            <div className="text-green-400 font-bold">âœ… å¯ä»¥å¼€å¯æ–°è½®æ¬¡</div>
                            <div className="text-sm text-gray-300 mt-1">
                                å‚¨å¤‡é‡‘: {tokenStatus.reservePool} BNB | å†å²è½®æ¬¡: {tokenStatus.totalRounds}
                            </div>
                            <button
                                onClick={() => onTokenSelect(tokenAddress)}
                                className="mt-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg"
                            >
                                é€‰æ‹©æ­¤ä»£å¸
                            </button>
                        </div>
                    ) : (
                        <div>
                            <div className="text-red-400 font-bold">âŒ è¯¥ä»£å¸å·²æœ‰æ´»è·ƒè½®æ¬¡</div>
                            <div className="text-sm text-gray-300 mt-1">
                                æ´»è·ƒè½®æ¬¡ID: #{tokenStatus.activeRoundId}
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}
```

## ğŸ¯ æ¸¸æˆç•Œé¢å±•ç¤º

```
ğŸ® BNBé“¾ç„šåŒ–ç‚‰ - å¤šä»£å¸ç‰ˆ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ğŸ“Š ä»£å¸æ¦‚è§ˆ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USDT  â”‚ è¿›è¡Œä¸­ â”‚ å‚¨å¤‡: 0.5 BNB â”‚ è½®æ¬¡: 3 â”‚ ğŸ® å‚ä¸  â”‚
â”‚ BUSD  â”‚ å¯å¼€å¯ â”‚ å‚¨å¤‡: 1.2 BNB â”‚ è½®æ¬¡: 5 â”‚ âš¡ å¼€å¯  â”‚
â”‚ CAKE  â”‚ å¯å¼€å¯ â”‚ å‚¨å¤‡: 0.0 BNB â”‚ è½®æ¬¡: 0 â”‚ ğŸ†• é¦–è½®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ æ´»è·ƒæ¸¸æˆè½®æ¬¡

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½®æ¬¡ #15 (USDT)              å¥–æ± : 1.8 BNB         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ åŸºç¡€å¥–æ± : 1.3 BNB                                  â”‚
â”‚ å‚¨å¤‡å¥–åŠ±: 0.5 BNB  â† æ¥è‡ªUSDTå†å²å‚¨å¤‡              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 15/20 â”‚ 0.01 â”‚ 100 USDT â”‚ 00:25:30                â”‚
â”‚ äººæ•°  â”‚ é—¨ç¥¨ â”‚ é”€æ¯ä»£å¸  â”‚ å‰©ä½™æ—¶é—´                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                ğŸ² ç«‹å³å‚ä¸                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

1. **ğŸ¯ å‚¨å¤‡é‡‘æµå‘æ¸…æ™°**ï¼šæ¯ç§ä»£å¸çš„å‚¨å¤‡é‡‘åªç»™è‡ªå·±çš„ä¸‹ä¸€åœº
2. **âš–ï¸ é¿å…ç«äº‰æ··ä¹±**ï¼šåŒç§ä»£å¸ä¸ä¼šæœ‰å¤šåœºæ¸¸æˆ
3. **ğŸ® é¼“åŠ±å¤šæ ·åŒ–**ï¼šè¦å¼€å¤šè½®å°±ç”¨ä¸åŒä»£å¸
4. **ğŸ’° ä»£å¸ç»æµå¾ªç¯**ï¼šæ¯ç§ä»£å¸å½¢æˆç‹¬ç«‹çš„å¥–åŠ±å¢é•¿
5. **ğŸ“ˆ æ¿€åŠ±æœºåˆ¶**ï¼šçƒ­é—¨ä»£å¸ä¼šç§¯ç´¯æ›´å¤§å‚¨å¤‡é‡‘

## ğŸš€ ç«‹å³å®ç°ï¼Ÿ

è¿™ä¸ªè®¾è®¡éå¸¸ä¼˜ç§€ï¼è¦ç«‹å³ä¿®æ”¹åˆçº¦å®ç°å—ï¼Ÿ

**å®ç°æ­¥éª¤**ï¼š
1. ä¿®æ”¹åˆçº¦æ•°æ®ç»“æ„
2. æ›´æ–°å¼€å¯/å‚ä¸/ç»“ç®—é€»è¾‘  
3. æ›´æ–°å‰ç«¯ç•Œé¢
4. é‡æ–°éƒ¨ç½²æµ‹è¯•

**ä½ è§‰å¾—è¿˜éœ€è¦ä»€ä¹ˆè°ƒæ•´å—ï¼Ÿ** ğŸ¯
